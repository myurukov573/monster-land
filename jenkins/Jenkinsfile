pipeline {
    agent any

    environment {
        IMAGE_NAME = "ghcr.io/myurukov573/monster-land"
        TAG = "latest"
        GHCR_TOKEN = credentials('ghcr-token')
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/myurukov573/monster-land.git'
            }
        }

        stage('Docker Build') {
            steps {
                sh 'docker build -t $IMAGE_NAME:$TAG .'
            }
        }

        stage('Push to GHCR') {
            steps {
                script {
                    try {
                        sh '''
                            echo $GHCR_TOKEN | docker login ghcr.io -u myurukov573 --password-stdin
                            docker push $IMAGE_NAME:$TAG
                        '''
                    } catch (err) {
                        echo "‚ö†Ô∏è Docker push failed: ${err}"
                    }
                }
            }
        }

        stage('Install Ansible Collections') {
            steps {
                dir('ansible') {
                    sh 'test -f requirements.yml && ansible-galaxy collection install -r requirements.yml || echo "No Ansible requirements.yml found."'
                }
            }
        }

        stage('Deploy via Ansible') {
            steps {
                dir('ansible') {
                    sh 'ansible-playbook -i inventory.ini deploy.yml -e "ghcr_token=$GHCR_TOKEN"'
                }
            }
        }
    }

    post {
        always {
            echo "üì¶ Cleaning workspace..."
            cleanWs()
        }
        failure {
            echo "‚ùå Build failed!"
        }
        success {
            echo "‚úÖ Deployment completed successfully!"
        }
    }
}
